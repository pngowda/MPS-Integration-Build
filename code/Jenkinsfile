node {
	def buildFile     = './code/build.gradle'
	def buildWrapper  = './code/gradlew'
	setupEnvironment()

	
		stage ('checkout'){ 
			echo "test"
			checkout scm
		}
		stage ('build'){
			echo "Building on branch: ${env.BRANCH_NAME}"
			echo "user: ${USER}"
			if(isUnix()) {
				//println Running on Linux slave
				sh "${buildWrapper} -b ${buildFile} buildrun"
			}
			else{
				//println Running on Windows slave
				bat "${buildWrapper} -b ${buildFile} buildrun"
			}
		}

		stage ('test'){
			 echo "Running tests on branch: ${env.BRANCH_NAME}"

				if(isUnix()) {
					//println Running on Linux slave
					sh "${buildWrapper} -b ${buildFile} testrun"
				}
				else{
					//println Running on Windows slave
					bat "${buildWrapper} -b ${buildFile} testrun"
				}
				step([$class: 'JUnitResultArchiver', testResults: 'TEST-*.xml'])


		}
	}
	def setupEnvironment() {
		def javaHome = tool(name: 'Oracle JDK8 Autoinstall')
		script {
            env.jdk_home = "${javaHome}"
        }
	}

